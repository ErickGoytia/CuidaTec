<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€” CuidaTec</title>
  <link rel="stylesheet" href="assets/css/styles.css">
  <style>
    .admin-badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
    }
    .admin-badge{
      border-radius:999px;
      padding:3px 10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,20,30,.9);
    }
    .table-admin th, .table-admin td{
      font-size:13px;
      vertical-align:middle;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin:12px 0;
      flex-wrap:wrap;
    }
    .tab{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(5,10,18,.9);
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{
      border-color:var(--c-accent);
      background:rgba(10,40,55,.95);
    }
    .status-badge{
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.14);
    }
    .status-nuevo{
      background:rgba(0,180,255,.15);
      color:#7fd8ff;
    }
    .status_en_proceso{
      background:rgba(255,210,0,.12);
      color:#ffe38c;
    }
    .status-resuelto{
      background:rgba(40,220,120,.15);
      color:#a4f7c7;
    }
  </style>
</head>

<body>
<header class="container header">
  <div class="brand">
    <div class="logo">ðŸ’§</div>
    <a href="index.html" class="brand-name">CuidaTec</a>
  </div>
  <nav class="nav">
    <a href="index.html">Inicio</a>
    <a href="reportar.html">Reportar</a>
    <a href="calculadora.html">Calculadora</a>
    <a href="consejos.html">Consejos</a>
    <a href="contacto.html">Contacto</a>
  </nav>
  <div class="header-blob"></div>
</header>

<main class="container">
  <div class="topbar">
    <div>
      <h2 style="margin:0">Panel administrador</h2>
      <div class="admin-badges">
        <span class="admin-badge">CuidaTec Â· GestiÃ³n de reportes</span>
        <span class="admin-badge">Estados y severidad</span>
        <span class="admin-badge">Acciones rÃ¡pidas</span>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="reportes">GestiÃ³n de reportes</button>
        <button class="tab" data-tab="asignaciones" disabled>Asignaciones (demo)</button>
        <button class="tab" data-tab="historial" disabled>Historial (demo)</button>
      </div>
    </div>
    <div>
      <button id="btnRefresh" class="btn">Refrescar</button>
      <button id="btnExport"  class="btn">Exportar CSV</button>
      <button id="btnLogout"  class="btn">Salir</button>
    </div>
  </div>

  <div class="card">
    <table class="table table-admin" id="tblReportes">
      <thead>
        <tr>
          <th>ID</th>
          <th>Folio</th>
          <th>TÃ­tulo</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Detalle</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="msgAdmin" class="muted"></p>
  </div>
</main>

<!-- Panel flotante de detalle -->
<div id="detailPanel" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,0.55);
  display:none; align-items:center; justify-content:center;
  z-index:50;">
  <div style="
    width:min(95vw,900px);
    max-height:90vh;
    overflow:auto;
    background:linear-gradient(180deg,rgba(10,15,25,.97),rgba(5,8,14,.97));
    border-radius:18px;
    border:1px solid var(--c-border);
    padding:18px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 id="detailTitle" style="margin:0">Detalle del reporte</h3>
      <button class="btn" id="detailClose">Cerrar</button>
    </div>
    <div id="detailContent" class="muted" style="font-size:13px"></div>
  </div>
</div>

<script src="assets/js/main.js"></script>
<script>
(function(){
  const API   = window.API_BASE;
  const $     = sel => document.querySelector(sel);
  const $$    = sel => Array.from(document.querySelectorAll(sel));

  const token = sessionStorage.getItem("token");
  const role  = sessionStorage.getItem("role");

  if (!token || role !== "admin") {
    // Si no estÃ¡ logueado como admin, mandarlo al login
    location.href = "login.html";
    return;
  }

  const tbody      = $("#tblReportes tbody");
  const msg        = $("#msgAdmin");
  const btnRefresh = $("#btnRefresh");
  const btnExport  = $("#btnExport");
  const btnLogout  = $("#btnLogout");

  const detailPanel   = $("#detailPanel");
  const detailContent = $("#detailContent");
  const detailTitle   = $("#detailTitle");
  const detailClose   = $("#detailClose");

  console.log("[ADMIN] API =", API);

  btnLogout.onclick = () => {
    sessionStorage.removeItem("token");
    sessionStorage.removeItem("role");
    location.href = "login.html";
  };

  btnRefresh.onclick = loadReportes;
  btnExport.onclick  = exportCSV;

  detailClose.onclick = () => detailPanel.style.display = "none";
  detailPanel.addEventListener("click", e => {
    if (e.target === detailPanel) detailPanel.style.display = "none";
  });

  function esc(s){
    return (s || "").toString().replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function estadoClass(nombre){
    if (!nombre) return "";
    const t = nombre.toLowerCase();
    if (t.includes("nuevo")) return "status-nuevo";
    if (t.includes("proceso")) return "status_en_proceso";
    if (t.includes("resuelto")) return "status-resuelto";
    return "";
  }

  async function loadReportes(){
    tbody.innerHTML = "";
    msg.textContent = "";

    try{
      const res = await fetch(API + "/api/reports", {
        headers:{ Authorization:"Bearer " + token }
      });

      if (res.status === 401 || res.status === 403){
        sessionStorage.clear();
        location.href = "login.html";
        return;
      }

      if (!res.ok){
        msg.textContent = "Error al cargar reportes.";
        return;
      }

      const data = await res.json();
      if (!data.length){
        msg.textContent = "Sin datos.";
        return;
      }

      data.forEach(r => {
        const tr = document.createElement("tr");
        const estadoText = r.estado || "";
        const cls = estadoClass(estadoText);

        tr.innerHTML = `
          <td>${r.reporte_id}</td>
          <td>${esc(r.folio || "")}</td>
          <td>${esc(r.titulo || "")}</td>
          <td>
            <span class="status-badge ${cls}">
              ${esc(estadoText || "N/D")}
            </span>
          </td>
          <td>${esc(r.fecha_reporte || "")}</td>
          <td>
            <button class="btn" data-detail="${r.reporte_id}">Ver</button>
          </td>
          <td>
            <button class="btn" data-resolve="${r.reporte_id}">Resolver</button>
            <button class="btn" data-delete="${r.reporte_id}">Borrar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Listeners para botones
      $$("button[data-detail]").forEach(btn => {
        btn.onclick = () => showDetail(btn.getAttribute("data-detail"));
      });

      $$("button[data-resolve]").forEach(btn => {
        btn.onclick = () => resolveReport(btn.getAttribute("data-resolve"));
      });

      $$("button[data-delete]").forEach(btn => {
        btn.onclick = () => deleteReport(btn.getAttribute("data-delete"));
      });

    }catch(err){
      console.error("[ADMIN] load error", err);
      msg.textContent = "No se pudo conectar con la API.";
    }
  }

  async function resolveReport(id){
    if (!confirm("Â¿Marcar este reporte como RESUELTO?")) return;

    try{
      const res = await fetch(API + "/api/reports/" + id + "/resolve", {
        method:"PATCH",
        headers:{ Authorization:"Bearer " + token }
      });

      if (!res.ok){
        alert("No se pudo marcar como resuelto.");
        return;
      }
      loadReportes();
    }catch(err){
      console.error(err);
      alert("Error al conectar con la API.");
    }
  }

  async function deleteReport(id){
    if (!confirm("Â¿Seguro que deseas borrar este reporte?")) return;

    try{
      const res = await fetch(API + "/api/reports/" + id, {
        method:"DELETE",
        headers:{ Authorization:"Bearer " + token }
      });

      if (!res.ok){
        alert("No se pudo borrar el reporte.");
        return;
      }
      loadReportes();
    }catch(err){
      console.error(err);
      alert("Error al conectar con la API.");
    }
  }

  async function showDetail(id){
    detailContent.innerHTML = "Cargando...";
    detailPanel.style.display = "flex";

    try{
      const res = await fetch(API + "/api/reports/" + id + "/detail", {
        headers:{ Authorization:"Bearer " + token }
      });

      if (!res.ok){
        detailContent.textContent = "Error cargando detalles.";
        return;
      }

      const payload = await res.json();
      const info      = payload.info || {};
      const historial = payload.historial || [];
      const asignaciones = payload.asignaciones || [];

      let html = "";
      html += `<p><b>Folio:</b> ${esc(info.folio || "")}</p>`;
      html += `<p><b>TÃ­tulo:</b> ${esc(info.titulo || "")}</p>`;
      html += `<p><b>DescripciÃ³n:</b><br>${esc(info.descripcion || "")}</p>`;
      html += `<p><b>Estado:</b> ${esc(info.estado || "")} Â· <b>Severidad:</b> ${esc(info.severidad || "")} Â· <b>CategorÃ­a:</b> ${esc(info.categoria || "")}</p>`;
      html += `<p><b>UbicaciÃ³n:</b> ${esc(info.calle || "")} ${esc(info.colonia || "")} ${esc(info.codigo_postal || "")}</p>`;
      html += `<p><b>Referencias:</b> ${esc(info.referencias || "")}</p>`;
      html += `<p><b>Reportante:</b> ${esc(info.reportante_nombre || "AnÃ³nimo")} (${esc(info.reportante_contacto || "N/D")})</p>`;
      html += `<p><b>Fecha reporte:</b> ${esc(info.fecha_reporte || "")} Â· <b>Fecha cierre:</b> ${esc(info.fecha_cierre || "Sin cerrar")}</p>`;

      html += `<hr><h4>Historial de estados</h4>`;
      if (!historial.length){
        html += `<p>Sin movimientos registrados.</p>`;
      } else {
        html += `<ul>`;
        historial.forEach(h => {
          html += `<li><b>${esc(h.fecha_cambio || "")}:</b> ${esc(h.estado_anterior || "N/A")} â†’ ${esc(h.estado_nuevo || "")} (${esc(h.observaciones || "")})</li>`;
        });
        html += `</ul>`;
      }

      html += `<hr><h4>Asignaciones</h4>`;
      if (!asignaciones.length){
        html += `<p>Sin asignaciones registradas.</p>`;
      } else {
        html += `<ul>`;
        asignaciones.forEach(a => {
          const nombre = a.estudiante_nombre || a.responsable || "Sin nombre";
          const extra  = a.matricula ? ` [${a.matricula}]` : "";
          html += `<li><b>${esc(a.fecha_asignacion || "")}:</b> ${esc(nombre + extra)} (${esc(a.correo || "")})</li>`;
        });
        html += `</ul>`;
      }

      detailContent.innerHTML = html;
      detailTitle.textContent = `Reporte #${info.reporte_id || id}`;

    }catch(err){
      console.error(err);
      detailContent.textContent = "Error cargando detalles.";
    }
  }

  function exportCSV(){
    const rows = Array.from(tbody.querySelectorAll("tr"))
      .map(tr => Array.from(tr.children).slice(0,5).map(td => td.textContent));
    if (!rows.length){
      alert("No hay datos para exportar.");
      return;
    }
    const header = ["ID","Folio","TÃ­tulo","Estado","Fecha"];
    const csv = [header].concat(rows)
      .map(r => r.map(x => JSON.stringify(x || "")).join(","))
      .join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reportes_cuidatec.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Inicial
  loadReportes();
})();
</script>
</body>
</html>
