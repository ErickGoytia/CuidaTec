<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin â€” CuidaTec</title>

  <!-- Estilos globales del sitio -->
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">

  <style>
    .admin-badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:12px;
    }
    .admin-badge{
      border-radius:999px;
      padding:3px 10px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,20,30,.9);
    }
    .table-admin th,
    .table-admin td{
      font-size:13px;
      vertical-align:middle;
    }
    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.4);
      background:rgba(15,23,42,0.9);
    }
    .status-nuevo,
    .status-pendiente{
      border-color:rgba(59,130,246,0.7);
      background:rgba(37,99,235,0.25);
      color:#dbeafe;
    }
    .status-en_proceso,
    .status-en-proceso{
      border-color:rgba(234,179,8,0.8);
      background:rgba(234,179,8,0.25);
      color:#facc15;
    }
    .status-resuelto,
    .status-cerrado{
      border-color:rgba(52,211,153,0.85);
      background:rgba(16,185,129,0.25);
      color:#bbf7d0;
    }
  </style>
</head>

<body>
<header class="container header">
  <div class="brand">
    <div class="logo">ðŸ’§</div>
    <a href="index.html" class="brand-name">CuidaTec</a>
  </div>
  <nav class="nav">
    <a href="index.html">Inicio</a>
    <a href="reportar.html">Reportar</a>
    <a href="calculadora.html">Calculadora</a>
    <a href="consejos.html">Consejos</a>
    <a href="contacto.html">Contacto</a>
  </nav>
  <div class="header-blob"></div>
</header>

<main class="container">
  <div class="topbar" data-aos="fade">
    <div>
      <h2 style="margin:0">Panel administrador</h2>
      <div class="admin-badges">
        <span class="admin-badge">GestiÃ³n de reportes</span>
        <span class="admin-badge">Asignaciones</span>
        <span class="admin-badge">Historial</span>
      </div>
    </div>
    <div>
      <button id="btnRefresh" class="btn">Refrescar</button>
      <button id="btnExport"  class="btn">Exportar CSV</button>
      <button id="btnLogout"  class="btn">Salir</button>
    </div>
  </div>

  <div class="card" data-aos="fade-up">
    <table class="table table-admin" id="tbl">
      <thead>
        <tr>
          <th>ID</th>
          <th>Folio</th>
          <th>TÃ­tulo</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Detalle</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="msg" class="muted"></p>
  </div>
</main>

<!-- Panel flotante de detalle -->
<div id="detailPanel" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:50;
">
  <div style="
    width:min(95vw,900px);
    max-height:90vh;
    overflow:auto;
    background:linear-gradient(180deg,rgba(10,15,25,.97),rgba(5,8,14,.97));
    border-radius:18px;
    border:1px solid var(--c-border);
    padding:18px;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 id="detailTitle" style="margin:0">Detalle del reporte</h3>
      <button class="btn" id="detailClose">Cerrar</button>
    </div>
    <div id="detailContent" class="muted" style="font-size:13px"></div>
  </div>
</div>

<!-- Scripts globales -->
<script src="assets/js/main.js"></script>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  AOS.init({ once:true, duration:700, easing:'ease-out' });

  // ==========================
  //  CONFIG / AUTH
  // ==========================
  const API   = (window.API_BASE || 'http://127.0.0.1:9090').replace(/\/+$/, '');
  const token = sessionStorage.getItem('token');

  console.log('[ADMIN] API =', API);

  if (!token) {
    location.href = 'login.html';
    return;
  }

  const tbody         = document.querySelector('#tbl tbody');
  const msg           = document.getElementById('msg');
  const btnLogout     = document.getElementById('btnLogout');
  const btnRefresh    = document.getElementById('btnRefresh');
  const btnExport     = document.getElementById('btnExport');
  const detailPanel   = document.getElementById('detailPanel');
  const detailContent = document.getElementById('detailContent');
  const detailClose   = document.getElementById('detailClose');
  const detailTitle   = document.getElementById('detailTitle');

  btnLogout.onclick = () => {
    sessionStorage.clear();
    location.href = 'login.html';
  };

  btnRefresh.onclick = () => load();
  btnExport.onclick  = () => exportCSV();

  detailClose.onclick = () => detailPanel.style.display = 'none';
  detailPanel.addEventListener('click', e => {
    if (e.target === detailPanel) detailPanel.style.display = 'none';
  });

  function escapeHtml(s){
    return (s || '').toString().replace(/[&<>"']/g, c => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    }[c]));
  }

  // ==========================
  //  Helper fetchJson (con header ngrok)
  // ==========================
  async function fetchJson(url, options = {}) {
    const baseHeaders = { 'ngrok-skip-browser-warning': 'true' };
    options.headers = { ...(options.headers || {}), ...baseHeaders };

    try {
      const res  = await fetch(url, options);
      const text = await res.text();

      if (!res.ok) {
        console.error('[fetchJson] HTTP', res.status, text);
        return { ok:false, status:res.status, error:'http' };
      }

      try {
        const data = JSON.parse(text);
        return { ok:true, data };
      } catch (e) {
        console.error('[fetchJson] Respuesta NO JSON desde', url, '=>', text);
        return { ok:false, status:res.status, error:'json' };
      }
    } catch (err) {
      console.error('[fetchJson] Error de red', err);
      return { ok:false, status:0, error:'network' };
    }
  }

  // ==========================
  //  LISTAR REPORTES
  // ==========================
  async function load(){
    tbody.innerHTML = '';
    msg.textContent = '';

    const r = await fetchJson(API + '/api/reports', {
      headers: { Authorization:'Bearer ' + token }
    });

    if (!r.ok) {
      msg.textContent = 'No se pudo conectar con la API.';
      return;
    }

    const data = r.data;
    if (!Array.isArray(data) || !data.length) {
      msg.textContent = 'Sin datos disponibles.';
      return;
    }

    data.forEach(rp => {
      const tr = document.createElement('tr');
      const estadoText = rp.estado || '';
      const estadoKey  = estadoText.toLowerCase().replace(/\s+/g,'_');

      tr.innerHTML = `
        <td>${rp.reporte_id}</td>
        <td>${escapeHtml(rp.folio || '')}</td>
        <td>${escapeHtml(rp.titulo || '')}</td>
        <td><span class="status-badge status-${estadoKey}">${escapeHtml(estadoText)}</span></td>
        <td>${escapeHtml(rp.fecha_reporte || '')}</td>
        <td><button class="btn" data-detail="${rp.reporte_id}">Ver</button></td>
        <td>
          <button class="btn" data-id="${rp.reporte_id}">Resolver</button>
          <button class="btn" data-delete="${rp.reporte_id}">Borrar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Resolver
    tbody.querySelectorAll('button[data-id]').forEach(btn => {
      btn.addEventListener('click', async e => {
        const id = e.target.getAttribute('data-id');
        if (!confirm(`Â¿Marcar el reporte #${id} como resuelto?`)) return;

        const res = await fetch(API + '/api/reports/' + id + '/resolve', {
          method:'PATCH',
          headers:{
            Authorization:'Bearer ' + token,
            'ngrok-skip-browser-warning':'true'
          }
        });

        if (res.ok) load();
        else alert('No se pudo marcar como resuelto.');
      });
    });

    // Ver detalle
    tbody.querySelectorAll('button[data-detail]').forEach(btn => {
      btn.addEventListener('click', () => showDetail(btn.getAttribute('data-detail')));
    });

    // Borrar
    tbody.querySelectorAll('button[data-delete]').forEach(btn => {
      btn.addEventListener('click', async e => {
        const id = e.target.getAttribute('data-delete');
        if (!confirm(`Â¿Borrar el reporte #${id}?`)) return;

        const res = await fetch(API + '/api/reports/' + id, {
          method:'DELETE',
          headers:{
            Authorization:'Bearer ' + token,
            'ngrok-skip-browser-warning':'true'
          }
        });

        if (res.ok) load();
        else alert('No se pudo borrar el reporte.');
      });
    });
  }

  // ==========================
  //  EXPORTAR CSV
  // ==========================
  function exportCSV(){
    const rows = Array.from(tbody.querySelectorAll('tr'))
      .map(tr => Array.from(tr.children).slice(0,5).map(td => td.textContent));

    if (!rows.length) {
      alert('No hay datos.');
      return;
    }

    const header = ['ID','Folio','TÃ­tulo','Estado','Fecha'];
    const csv = [header].concat(rows)
      .map(r => r.map(x => JSON.stringify(x || '')).join(','))
      .join('\n');

    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'reportes_cuidatec.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ==========================
  //  DETALLE
  // ==========================
  async function showDetail(id){
    detailContent.innerHTML = 'Cargando...';
    detailPanel.style.display = 'flex';

    const r = await fetchJson(API + '/api/reports/' + id + '/detail', {
      headers:{ Authorization:'Bearer ' + token }
    });

    if (!r.ok) {
      detailContent.textContent = 'Error cargando detalles.';
      return;
    }

    const payload      = r.data || {};
    const info         = payload.info || {};
    const historial    = payload.historial || [];
    const asignaciones = payload.asignaciones || [];

    let html = `
      <p><b>Folio:</b> ${escapeHtml(info.folio || '')}</p>
      <p><b>TÃ­tulo:</b> ${escapeHtml(info.titulo || '')}</p>
      <p><b>DescripciÃ³n:</b><br>${escapeHtml(info.descripcion || '')}</p>
      <p><b>Estado:</b> ${escapeHtml(info.estado || '')} Â·
         <b>Severidad:</b> ${escapeHtml(info.severidad || '')} Â·
         <b>CategorÃ­a:</b> ${escapeHtml(info.categoria || '')}</p>
      <p><b>UbicaciÃ³n:</b> ${escapeHtml(info.calle || '')}
         ${escapeHtml(info.colonia || '')}
         ${escapeHtml(info.codigo_postal || '')}</p>
      <p><b>Referencias:</b> ${escapeHtml(info.referencias || '')}</p>
      <p><b>Reportante:</b> ${escapeHtml(info.reportante_nombre || 'AnÃ³nimo')}
         (${escapeHtml(info.reportante_contacto || 'N/D')})</p>
      <p><b>Fecha reporte:</b> ${escapeHtml(info.fecha_reporte || '')} Â·
         <b>Fecha cierre:</b> ${escapeHtml(info.fecha_cierre || 'Sin cerrar')}</p>
      <hr><h4>Historial</h4>
    `;

    if (!historial.length){
      html += `<p>Sin historial registrado.</p>`;
    } else {
      html += `<ul>`;
      historial.forEach(h => {
        html += `<li><b>${escapeHtml(h.fecha_cambio || '')}:</b>
                   ${escapeHtml(h.estado_anterior || 'N/D')}
                   â†’ ${escapeHtml(h.estado_nuevo || '')}
                   (${escapeHtml(h.observaciones || '')})
                 </li>`;
      });
      html += `</ul>`;
    }

    html += `<hr><h4>Asignaciones</h4>`;
    if (!asignaciones.length){
      html += `<p>Sin asignaciones.</p>`;
    } else {
      html += `<ul>`;
      asignaciones.forEach(a => {
        const nombre = a.estudiante_nombre || a.responsable || 'Sin nombre';
        const extra  = a.matricula ? ` [${a.matricula}]` : '';
        html += `<li><b>${escapeHtml(a.fecha_asignacion || '')}:</b>
                   ${escapeHtml(nombre + extra)}
                   (${escapeHtml(a.correo || '')})
                 </li>`;
      });
      html += `</ul>`;
    }

    // Zona de asignar brigada / responsable
    html += `
      <hr>
      <h4>Asignar brigada / responsable</h4>
      <div id="assignArea">
        <p class="muted">Selecciona una brigada o escribe un responsable.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <select id="assignStudent" style="flex:1;min-width:200px"></select>
          <input id="assignResponsable" placeholder="Responsable (opcional)" style="flex:1;min-width:200px">
        </div>
        <button class="btn" id="assignBtn">Asignar</button>
        <p id="assignMsg" class="muted"></p>
      </div>
    `;

    detailContent.innerHTML = html;
    detailTitle.textContent = `Reporte #${info.reporte_id || id}`;

    await fillStudents(id);
  }

  // ==========================
  //  LLENAR BRIGADAS
  // ==========================
  async function fillStudents(reporteId){
    const sel   = document.getElementById('assignStudent');
    const msgEl = document.getElementById('assignMsg');
    const btn   = document.getElementById('assignBtn');
    const resp  = document.getElementById('assignResponsable');

    sel.innerHTML = '<option value="">(Selecciona brigada)</option>';

    const r = await fetchJson(API + '/api/students', {
      headers:{ Authorization:'Bearer ' + token }
    });

    if (!r.ok) {
      msgEl.textContent = 'No se pudieron cargar brigadas.';
      return;
    }

    (r.data || []).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.estudiante_id;
      opt.textContent = `${s.nombre} (${s.matricula})`;
      sel.appendChild(opt);
    });

    btn.onclick = async () => {
      msgEl.textContent = '';
      const estudiante_id = sel.value ? Number(sel.value) : null;
      const responsable   = resp.value.trim() || null;

      if (!estudiante_id && !responsable){
        msgEl.textContent = 'Selecciona brigada o escribe responsable.';
        return;
      }

      const res = await fetch(API + '/api/reports/' + reporteId + '/assign', {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          Authorization:'Bearer ' + token,
          'ngrok-skip-browser-warning':'true'
        },
        body: JSON.stringify({ estudiante_id, responsable })
      });

      if (res.ok){
        msgEl.textContent = 'AsignaciÃ³n registrada.';
        showDetail(reporteId);
      } else {
        msgEl.textContent = 'No se pudo asignar.';
      }
    };
  }

  // Arranque inicial
  load();
});
</script>

</body>
</html>
